{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedAtlas - Find Healthcare Services</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px; line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    header { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px; }
    h1 { color: #667eea; font-size: 2.5rem; font-weight: 700; margin-bottom: 8px; }
    .tagline { color: #64748b; font-size: 1.1rem; }

    .filter-section { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .filter-section h2 { color: #1e293b; font-size: 1.3rem; margin-bottom: 20px; }
    .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; }
    label { color: #475569; font-size: 0.9rem; font-weight: 500; margin-bottom: 6px; }
    input[type="text"], select {
      padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s;
    }
    input[type="text"]:focus, select:focus { outline: none; border-color: #667eea; }
    .checkbox-group { display: flex; align-items: center; gap: 8px; padding: 12px 0; }
    .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .checkbox-group label { margin: 0; cursor: pointer; }
    .filter-actions { display: flex; gap: 12px; margin-top: 20px; }
    button { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
    .btn-secondary { background: #e2e8f0; color: #475569; text-decoration: none; display: inline-block; text-align: center;
    padding: 6px;
    border-radius: 8px;}

    .results-header {
      background: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
    }
    .results-count { color: #475569; font-size: 1.1rem; }
    .results-count strong { color: #667eea; font-size: 1.3rem; }

    .listings-grid { display: grid; gap: 20px; margin-bottom: 30px; }
    .listing-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; }
    .listing-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
    .listing-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
    .listing-title { color: #1e293b; font-size: 1.3rem; font-weight: 700; margin-bottom: 4px; }
    .verified-badge { background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    .organization { color: #667eea; font-size: 1rem; margin-bottom: 12px; }

    .listing-details { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
    .detail-item { color: #64748b; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
    .detail-icon { color: #667eea; font-weight: bold; }

    .cost-badge { display: inline-block; padding: 4px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; margin-top: 8px; }
    .cost-free { background: #d1fae5; color: #065f46; }
    .cost-low { background: #e0f2fe; color: #075985; }
    .cost-sliding { background: #dbeafe; color: #1e40af; }
    .cost-varies { background: #fef3c7; color: #92400e; }

    .listing-actions { display: flex; gap: 10px; margin-top: 15px; }
    .btn-link { padding: 8px 16px; background: #f1f5f9; color: #667eea; text-decoration: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; transition: all 0.3s; }
    .btn-link:hover { background: #667eea; color: white; }

    .pagination {
      background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex; justify-content: center; align-items: center; gap: 15px;
    }
    .page-info { color: #475569; font-weight: 500; }
    .no-results { background: white; padding: 60px 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
    .no-results h3 { color: #64748b; font-size: 1.5rem; margin-bottom: 10px; }
    .no-results p { color: #94a3b8; }

    @media (max-width: 768px) {
      h1 { font-size: 2rem; }
      .filter-grid { grid-template-columns: 1fr; }
      .results-header { flex-direction: column; align-items: start; gap: 10px; }
      .filter-actions { flex-direction: column; }
      .filter-actions .btn-primary, .filter-actions .btn-secondary { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè• MedAtlas</h1>
      <p class="tagline">Find accessible healthcare services in your area</p>
    </header>

    <div class="filter-section">
      <h2>Search & Filter</h2>
      <form method="get" id="filterForm">
        <div class="filter-grid">
          <div class="form-group">
            <label for="searchQuery">Search</label>
            <input type="text" id="searchQuery" name="q" placeholder="Name, organization, city, or state" value="{{ filters.q }}">
          </div>
          <div class="form-group">
            <label for="cityFilter">City</label>
            <!-- The view expects a city slug (city_slug), e.g., 'sac' -->
            <input type="text" id="cityFilter" name="city" placeholder="City code (e.g., sac)" value="{{ filters.city }}">
          </div>
          <div class="form-group">
            <label for="stateFilter">State</label>
            <input type="text" id="stateFilter" name="state" placeholder="e.g., CA" value="{{ filters.state }}">
          </div>
          <div class="form-group">
            <label for="costFilter">Cost Type</label>
            <!-- Values must match model choices: free, low_cost, sliding, varies -->
            <select id="costFilter" name="cost">
              <option value="">Any cost</option>
              <option value="free" {% if filters.cost == "free" %}selected{% endif %}>Free</option>
              <option value="low_cost" {% if filters.cost == "low_cost" %}selected{% endif %}>Low cost</option>
              <option value="sliding" {% if filters.cost == "sliding" %}selected{% endif %}>Sliding scale</option>
              <option value="varies" {% if filters.cost == "varies" %}selected{% endif %}>Varies</option>
            </select>
          </div>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="verifiedOnly" name="verified" value="1" {% if filters.verified in "1 true yes on" %}checked{% endif %}>
          <label for="verifiedOnly">Show verified listings only</label>
        </div>

        <div class="filter-actions">
          <button type="submit" class="btn-primary">Apply Filters</button>
          <a href="{% url 'showcase:index' %}" class="btn-secondary">Reset</a>

        </div>
      </form>
    </div>

    <div class="results-header">
      <div class="results-count">
        Showing <strong>{{ page_obj.paginator.count }}</strong> results
      </div>
      {% if filters.q or filters.city or filters.state or filters.cost or filters.verified %}
        <div class="results-count">
          Active filters:
          {% if filters.q %}<em>q="{{ filters.q }}"</em>{% endif %}
          {% if filters.city %} <em>city="{{ filters.city }}"</em>{% endif %}
          {% if filters.state %} <em>state="{{ filters.state }}"</em>{% endif %}
          {% if filters.cost %} <em>cost="{{ filters.cost }}"</em>{% endif %}
          {% if filters.verified %} <em>verified</em>{% endif %}
        </div>
      {% endif %}
    </div>

    <div class="listings-grid" id="listingsContainer">
      {% for item in listings %}
        <div class="listing-card">
          <div class="listing-header">
            <div>
              <h3 class="listing-title">{{ item.name }}</h3>
              {% if item.organization_name %}
                <div class="organization">{{ item.organization_name }}</div>
              {% endif %}
            </div>
            {% if item.verified %}
              <span class="verified-badge">‚úì Verified</span>
            {% endif %}
          </div>

          <div class="listing-details">
            <div class="detail-item">
              <span class="detail-icon">üìç</span>
              <span>{{ item.city_text }}, {{ item.state }}</span>
            </div>
            {% if item.phone %}
              <div class="detail-item">
                <span class="detail-icon">üìû</span>
                <span>{{ item.phone }}</span>
              </div>
            {% endif %}
          </div>

          {% comment %}
            Use model choices to display a human label:
            {{ item.get_cost_display }} ‚Üí "Free", "Low cost", "Sliding scale", "Varies"
          {% endcomment %}
          {% if item.cost %}
            {% with c=item.cost %}
              <span class="cost-badge
                {% if c == 'free' %}cost-free{% elif c == 'low_cost' %}cost-low{% elif c == 'sliding' %}cost-sliding{% elif c == 'varies' %}cost-varies{% endif %}
              ">{{ item.get_cost_display }}</span>
            {% endwith %}
          {% endif %}

          {% if item.website %}
            <div class="listing-actions">
              <a href="{{ item.website }}" target="_blank" class="btn-link">Visit Website ‚Üí</a>
            </div>
          {% endif %}
        </div>
      {% empty %}
        <div class="no-results">
          <h3>No listings found</h3>
          <p>Try adjusting your filters to see more results</p>
        </div>
      {% endfor %}
    </div>

    {% if is_paginated %}
      <div class="pagination" id="pagination">
        {% if page_obj.has_previous %}
          <a class="btn-secondary" href="?page={{ page_obj.previous_page_number }}{% if request.GET %}&{{ request.GET.urlencode|safe }}{% endif %}">Previous</a>
        {% else %}
          <span class="btn-secondary" style="opacity:0.5; cursor:not-allowed;">Previous</span>
        {% endif %}

        <span class="page-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
          <a class="btn-secondary" href="?page={{ page_obj.next_page_number }}{% if request.GET %}&{{ request.GET.urlencode|safe }}{% endif %}">Next</a>
        {% else %}
          <span class="btn-secondary" style="opacity:0.5; cursor:not-allowed;">Next</span>
        {% endif %}
      </div>
    {% endif %}
  </div>
<script>
  // --- Helpers ---
  function qs(el) { return document.querySelector(el); }
  function qsa(el) { return Array.from(document.querySelectorAll(el)); }

  const API_URL = "{% url 'showcase:api_listings' %}";

  const form = qs('#filterForm');
  const listingsContainer = qs('#listingsContainer');
  const resultCountEl = document.querySelector('.results-count strong');
  const paginationEl = document.querySelector('#pagination') || createPaginationShell();

  function createPaginationShell() {
    const div = document.createElement('div');
    div.id = 'pagination';
    div.className = 'pagination';
    div.innerHTML = `
      <a class="btn-secondary" id="prevBtn" href="#" style="display:none">Previous</a>
      <span class="page-info" id="pageInfo"></span>
      <a class="btn-secondary" id="nextBtn" href="#" style="display:none">Next</a>
    `;
    document.querySelector('.container').appendChild(div);
    return div;
  }

  function currentParams(pageOverride) {
    const params = new URLSearchParams();
    const q = qs('#searchQuery').value.trim();
    const city = qs('#cityFilter').value.trim();
    const state = qs('#stateFilter').value.trim();
    const cost = qs('#costFilter').value;
    const verified = qs('#verifiedOnly').checked ? '1' : '';

    if (q) params.set('q', q);
    if (city) params.set('city', city);          // city_slug (e.g., 'sac')
    if (state) params.set('state', state);        // 'CA'
    if (cost) params.set('cost', cost);           // 'free' | 'low_cost' | 'sliding' | 'varies'
    if (verified) params.set('verified', '1');

    // If you have service chips/checkboxes, collect them like:
    // qsa('input[name="services"]:checked').forEach(cb => params.append('services', cb.value));

    if (pageOverride) params.set('page', pageOverride);
    return params;
  }

  async function fetchListings(page = null) {
    const params = currentParams(page);
    const url = `${API_URL}?${params.toString()}`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
    if (!res.ok) {
      throw new Error(`Failed to fetch listings: ${res.status}`);
    }
    return res.json();
  }

  function renderCard(item) {
    const costClass =
      item.cost === 'free' ? 'cost-free' :
      item.cost === 'low_cost' ? 'cost-low' :
      item.cost === 'sliding' ? 'cost-sliding' :
      item.cost === 'varies' ? 'cost-varies' : '';

    return `
      <div class="listing-card">
        <div class="listing-header">
          <div>
            <h3 class="listing-title">${escapeHtml(item.name)}</h3>
            ${item.organization_name ? `<div class="organization">${escapeHtml(item.organization_name)}</div>` : ''}
          </div>
          ${item.verified ? '<span class="verified-badge">‚úì Verified</span>' : ''}
        </div>

        <div class="listing-details">
          <div class="detail-item">
            <span class="detail-icon">üìç</span>
            <span>${escapeHtml(item.city_text)}, ${escapeHtml(item.state)}</span>
          </div>
          ${item.phone ? `
            <div class="detail-item">
              <span class="detail-icon">üìû</span>
              <span>${escapeHtml(item.phone)}</span>
            </div>` : ''}
        </div>

        ${item.cost ? `<span class="cost-badge ${costClass}">${escapeHtml(item.cost_label)}</span>` : ''}

        ${item.website ? `
          <div class="listing-actions">
            <a href="${escapeAttr(item.website)}" target="_blank" class="btn-link">Visit Website ‚Üí</a>
          </div>` : ''}
      </div>
    `;
  }

  function renderResults(data) {
    const results = data.results || [];
    resultCountEl.textContent = data.count ?? results.length;

    if (results.length === 0) {
      listingsContainer.innerHTML = `
        <div class="no-results">
          <h3>No listings found</h3>
          <p>Try adjusting your filters to see more results</p>
        </div>
      `;
      renderPagination(null, null, null);
      return;
    }

    listingsContainer.innerHTML = results.map(renderCard).join('');
    renderPagination(data.previous, data.next, data);
  }

  function renderPagination(previousUrl, nextUrl, data) {
    const prevBtn = qs('#prevBtn') || addBtn('prevBtn');
    const nextBtn = qs('#nextBtn') || addBtn('nextBtn');
    const pageInfo = qs('#pageInfo') || addInfo();

    function addBtn(id) {
      const a = document.createElement('a');
      a.className = 'btn-secondary';
      a.id = id;
      a.href = '#';
      paginationEl.insertBefore(a, id === 'prevBtn' ? paginationEl.firstChild : null);
      return a;
    }
    function addInfo() {
      const span = document.createElement('span');
      span.className = 'page-info';
      span.id = 'pageInfo';
      paginationEl.insertBefore(span, nextBtn);
      return span;
    }

    // DRF doesn‚Äôt directly give page numbers; compute approximate page display
    const params = new URLSearchParams(location.search);
    const currentPage = parseInt(params.get('page') || '1', 10);
    const pageSize = data && data.results ? data.results.length : 0;
    const count = data && typeof data.count === 'number' ? data.count : 0;
    const totalPages = pageSize ? Math.max(1, Math.ceil(count / pageSize)) : 1;

    pageInfo.textContent = `Page ${isNaN(currentPage) ? 1 : currentPage} of ${totalPages}`;

    if (previousUrl) {
      prevBtn.style.display = '';
      prevBtn.onclick = (e) => { e.preventDefault(); goPage(currentPage - 1); };
    } else {
      prevBtn.style.display = 'none';
      prevBtn.onclick = null;
    }

    if (nextUrl) {
      nextBtn.style.display = '';
      nextBtn.onclick = (e) => { e.preventDefault(); goPage(currentPage + 1); };
    } else {
      nextBtn.style.display = 'none';
      nextBtn.onclick = null;
    }
  }

  async function goPage(n) {
    const data = await fetchListings(n);
    // update URL (optional, so back/forward works)
    const params = currentParams(n);
    history.replaceState(null, '', `?${params.toString()}`);
    renderResults(data);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function escapeAttr(s) {
    return escapeHtml(s).replace(/"/g, '&quot;');
  }

  // Intercept form submit to call API
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = await fetchListings(1);
    // sync URL with filters (page=1)
    const params = currentParams(1);
    history.replaceState(null, '', `?${params.toString()}`);
    renderResults(data);
  });

  // Auto-load using URL params (supports direct linking)
  (async function initFromUrl() {
    // Prefill form from URL if arriving via a link
    const urlParams = new URLSearchParams(location.search);
    if (urlParams.has('q')) qs('#searchQuery').value = urlParams.get('q');
    if (urlParams.has('city')) qs('#cityFilter').value = urlParams.get('city');
    if (urlParams.has('state')) qs('#stateFilter').value = urlParams.get('state');
    if (urlParams.has('cost')) qs('#costFilter').value = urlParams.get('cost');
    if (urlParams.has('verified')) qs('#verifiedOnly').checked = ['1','true','yes','on'].includes(urlParams.get('verified'));

    const page = parseInt(urlParams.get('page') || '1', 10);
    try {
      const data = await fetchListings(page);
      renderResults(data);
    } catch (err) {
      // If API fails, leave server-rendered content as-is
      // (you can surface a toast if desired)
      console.error(err);
    }
  })();
</script>


</body>
</html>
